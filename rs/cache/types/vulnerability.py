"""
Cache implementations for vulnerability-related data.

This module provides cache implementations for:
- NVD query results
- OSV query results
- CVE entries
- OSV entries
- Patch information
- Generic vulnerability entries
- CPE match results
"""

from pathlib import Path
from typing import Any, Dict, List, Optional

from ..base import BaseCache
from ..utils import compute_hash, format_cache_id


class NvdQueryCache(BaseCache[Dict[str, Any], str]):
    """
    Cache for NVD (National Vulnerability Database) API query results.

    Cache key: SHA256 hash of the query keyword
    File format: Raw JSON response from NVD API
    """

    cache_type = "nvd_query"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "nvd_query_cache"

    def compute_cache_key(self, keyword: str) -> str:
        """Hash the keyword for filesystem-safe filename."""
        return compute_hash(keyword)

    def serialize(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """Raw dict data, no transformation needed."""
        return data

    def deserialize(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """Raw dict data, no transformation needed."""
        return data


class OsvQueryCache(BaseCache[List[Dict[str, Any]], tuple]):
    """
    Cache for OSV (Open Source Vulnerabilities) API query results.

    Cache key: SHA256 hash of project name + version
    File format: List of raw JSON responses from OSV API
    """

    cache_type = "osv_query"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "osv_query_cache"

    def compute_cache_key(self, proj_name: str, proj_version: str) -> str:
        """Hash the project name and version combination."""
        query_key = f"{proj_name}##{proj_version}"
        return compute_hash(query_key)

    def serialize(self, data: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """List of dicts, stored directly."""
        return data  # type: ignore

    def deserialize(self, data: Any) -> List[Dict[str, Any]]:
        """List of dicts, loaded directly."""
        return data


class CveEntryCache(BaseCache[Any, str]):
    """
    Cache for CVE (Common Vulnerabilities and Exposures) entries.

    Cache key: Formatted CVE ID (e.g., "CVE-2024-1234")
    File format: Serialized CVEEntry object
    """

    cache_type = "cve_entry"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "cve_data"

    def compute_cache_key(self, cve_id: str) -> str:
        """Use formatted CVE ID as key."""
        return format_cache_id(cve_id)

    def serialize(self, data: Any) -> Dict[str, Any]:
        """Convert CVEEntry to dict using its to_dict method."""
        if hasattr(data, 'to_dict'):
            return data.to_dict()
        return data

    def deserialize(self, data: Dict[str, Any]) -> Any:
        """Reconstruct CVEEntry from dict."""
        try:
            from patch_fetcher.patch_proto import CVEEntry
            return CVEEntry.from_dict(data)
        except ImportError:
            return data


class OsvEntryCache(BaseCache[Any, str]):
    """
    Cache for OSV (Open Source Vulnerabilities) entries.

    Cache key: Formatted OSV ID
    File format: Serialized OSVEntry object
    """

    cache_type = "osv_entry"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "osv_data"

    def compute_cache_key(self, osv_id: str) -> str:
        """Use formatted OSV ID as key."""
        return format_cache_id(osv_id)

    def serialize(self, data: Any) -> Dict[str, Any]:
        """Convert OSVEntry to dict using its to_dict method."""
        if hasattr(data, 'to_dict'):
            return data.to_dict()
        return data

    def deserialize(self, data: Dict[str, Any]) -> Any:
        """Reconstruct OSVEntry from dict."""
        try:
            from patch_fetcher.patch_proto import OSVEntry
            return OSVEntry.from_dict(data)
        except ImportError:
            return data


class PatchInfoCache(BaseCache[Any, str]):
    """
    Cache for patch information with vulnerability entries.

    Cache key: Formatted vulnerability ID
    File format: Serialized PatchInfoWithEntry object
    """

    cache_type = "patch_info"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "patch_info"

    def compute_cache_key(self, vuln_id: str) -> str:
        """Use formatted vulnerability ID as key."""
        return format_cache_id(vuln_id)

    def serialize(self, data: Any) -> Dict[str, Any]:
        """Convert PatchInfoWithEntry to dict using its to_dict method."""
        if hasattr(data, 'to_dict'):
            return data.to_dict()
        return data

    def deserialize(self, data: Dict[str, Any]) -> Any:
        """Reconstruct PatchInfoWithEntry from dict."""
        try:
            from patch_fetcher.patch_proto import PatchInfoWithEntry
            return PatchInfoWithEntry.from_dict(data)
        except ImportError:
            return data


class GenericEntryCache(BaseCache[Any, str]):
    """
    Cache for generic vulnerability entries.

    Cache key: Formatted entry ID
    File format: Serialized GenericEntry object
    """

    cache_type = "generic_entry"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "generic_data"

    def compute_cache_key(self, entry_id: str) -> str:
        """Use formatted entry ID as key."""
        return format_cache_id(entry_id)

    def serialize(self, data: Any) -> Dict[str, Any]:
        """Convert GenericEntry to dict using its to_dict method."""
        if hasattr(data, 'to_dict'):
            return data.to_dict()
        return data

    def deserialize(self, data: Dict[str, Any]) -> Any:
        """Reconstruct GenericEntry from dict."""
        try:
            from patch_fetcher.patch_proto import GenericEntry
            return GenericEntry.from_dict(data)
        except ImportError:
            return data


class CpeMatchCache(BaseCache[Dict[str, Any], str]):
    """
    Cache for CPE (Common Platform Enumeration) match results.

    Cache key: SHA256 hash of CPE string
    File format: Raw JSON response from NVD CPE match API
    """

    cache_type = "cpe_match"
    default_ttl_days = 21
    shared_by_default = True

    def get_base_dir(self) -> Path:
        return self._config.dataset_dir / "cpe_match_cache"

    def compute_cache_key(self, cpe_string: str) -> str:
        """Hash the CPE string for filesystem-safe filename."""
        return compute_hash(cpe_string)

    def serialize(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """Raw dict data, no transformation needed."""
        return data

    def deserialize(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """Raw dict data, no transformation needed."""
        return data
